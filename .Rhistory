label = "Aggregated (dashed) trend:\nnegative ⇒ Simpson's paradox",
size = 4.2, fill = "#FFF3F0", color = "grey20", label.size = 0.2) +
annotate("curve", x = 7.6, y = 9.4, xend = 6.6, yend = 7.2,
curvature = 0.3, color = "black",
arrow = arrow(length = unit(0.25, "cm"))) +
# ---- Scales, labels, theme ----
scale_color_manual(values = pal) +
labs(
x = "x",
y = "y",
color = "Group"
) +
theme_classic(base_size = 13) +
theme(
legend.position.inside = c(.5,.9),
legend.title = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "grey88"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 16),
plot.subtitle = element_text(size = 12, color = "grey30"),
plot.caption = element_text(color = "grey40")
)
p
#| fig-cap: "OLS regression & Simpson's Paradox"
#| fig-subcap:
#|  - "OLS regression with cross-sectional data"
#|  - "Simpson's Paradox"
#| label: fig-simp
#| eval: true
#| echo: false
#| layout-ncol: 2
#| warning: false
mtcars |>
ggplot(aes(x = hp, y = mpg)) +
geom_point(size = 2, alpha = .5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
labs(x = "Horsepower", y = "Miles-per-gallon",
caption = "Data: mtcars")
set.seed(42)
# ---- Simulate data ----
# Within each group: y increases with x (positive slope).
# Groups differ in their x-range and intercepts (confounder).
n <- 250
df <- bind_rows(
tibble(group = "Group A",
x = runif(n, 0, 5),
y = 0.6 * x + 12 + rnorm(n, sd = 0.6)),
tibble(group = "Group B",
x = runif(n, 5, 10),
y = 0.6 * x - 2 + rnorm(n, sd = 0.6))
)
# ---- Fit simple linear models ----
overall_lm <- lm(y ~ x, data = df)
overall_slope <- unname(coef(overall_lm)[2])
group_lm <- df %>%
group_by(group) %>%
summarise(
slope = unname(coef(lm(y ~ x))[2]),
intercept = unname(coef(lm(y ~ x))[1]),
.groups = "drop"
)
# ---- Colors (Okabe–Ito, colorblind-friendly) ----
pal <- c("Group A" = "#0072B2",  # blue
"Group B" = "#D55E00")  # vermillion
# ---- Build plot ----
p <- ggplot(df, aes(x = x, y = y, color = group)) +
# Light background shading to reveal different x-ranges (confounder)
annotate("rect", xmin = 0, xmax = 5, ymin = -Inf, ymax = Inf,
fill = "grey90", alpha = 0.25) +
annotate("rect", xmin = 5, xmax = 10, ymin = -Inf, ymax = Inf,
fill = "grey95", alpha = 0.25) +
# Points and within-group regressions
geom_point(alpha = 0.55, size = 2) +
geom_smooth(method = "lm", se = FALSE, size = 1.2) +
# Aggregated regression (dashed black): shows reversal
geom_smooth(aes(group = 1), method = "lm", se = FALSE,
color = "black", linetype = "longdash", linewidth = 1.3) +
# ---- Annotations highlighting the paradox ----
# Label the confounder: different x-distributions by group
annotate("segment", x = 5, xend = 5,
y = min(df$y) - 0.5, yend = max(df$y) + 0.5,
linetype = "dotted", color = "grey40") +
# Within-group positive relationship annotation (two arrows)
annotate("label", x = 2.2, y = 14.8,
label = "Within each group:\npositive relationship",
size = 4.2, fill = "#F8F8F8", color = "grey20", label.size = 0.2) +
annotate("curve", x = 2.2, y = 14.3, xend = 3.6, yend = 13.5,
curvature = 0.25, color = pal["Group A"],
arrow = arrow(length = unit(0.25, "cm"))) +
annotate("curve", x = 2.2, y = 15.2, xend = 8.3, yend = 4.0,
curvature = -0.2, color = pal["Group B"],
arrow = arrow(length = unit(0.25, "cm"))) +
# Aggregated negative relationship annotation
annotate("label", x = 7.8, y = 9.8,
label = "Aggregated (dashed) trend:\nnegative ⇒ Simpson's paradox",
size = 4.2, fill = "#FFF3F0", color = "grey20", label.size = 0.2) +
annotate("curve", x = 7.6, y = 9.4, xend = 6.6, yend = 7.2,
curvature = 0.3, color = "black",
arrow = arrow(length = unit(0.25, "cm"))) +
# ---- Scales, labels, theme ----
scale_color_manual(values = pal) +
labs(
x = "x",
y = "y",
color = "Group"
) +
theme_classic(base_size = 13) +
theme(
legend.position.inside = c(.5,.9),
legend.location = "plot",
legend.title = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "grey88"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 16),
plot.subtitle = element_text(size = 12, color = "grey30"),
plot.caption = element_text(color = "grey40")
)
p
#| fig-cap: "OLS regression & Simpson's Paradox"
#| fig-subcap:
#|  - "OLS regression with cross-sectional data"
#|  - "Simpson's Paradox"
#| label: fig-simp
#| eval: true
#| echo: false
#| layout-ncol: 2
#| warning: false
mtcars |>
ggplot(aes(x = hp, y = mpg)) +
geom_point(size = 2, alpha = .5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
labs(x = "Horsepower", y = "Miles-per-gallon",
caption = "Data: mtcars")
set.seed(42)
# ---- Simulate data ----
# Within each group: y increases with x (positive slope).
# Groups differ in their x-range and intercepts (confounder).
n <- 250
df <- bind_rows(
tibble(group = "Group A",
x = runif(n, 0, 5),
y = 0.6 * x + 12 + rnorm(n, sd = 0.6)),
tibble(group = "Group B",
x = runif(n, 5, 10),
y = 0.6 * x - 2 + rnorm(n, sd = 0.6))
)
# ---- Fit simple linear models ----
overall_lm <- lm(y ~ x, data = df)
overall_slope <- unname(coef(overall_lm)[2])
group_lm <- df %>%
group_by(group) %>%
summarise(
slope = unname(coef(lm(y ~ x))[2]),
intercept = unname(coef(lm(y ~ x))[1]),
.groups = "drop"
)
# ---- Colors (Okabe–Ito, colorblind-friendly) ----
pal <- c("Group A" = "#0072B2",  # blue
"Group B" = "#D55E00")  # vermillion
# ---- Build plot ----
p <- ggplot(df, aes(x = x, y = y, color = group)) +
# Light background shading to reveal different x-ranges (confounder)
annotate("rect", xmin = 0, xmax = 5, ymin = -Inf, ymax = Inf,
fill = "grey90", alpha = 0.25) +
annotate("rect", xmin = 5, xmax = 10, ymin = -Inf, ymax = Inf,
fill = "grey95", alpha = 0.25) +
# Points and within-group regressions
geom_point(alpha = 0.55, size = 2) +
geom_smooth(method = "lm", se = FALSE, size = 1.2) +
# Aggregated regression (dashed black): shows reversal
geom_smooth(aes(group = 1), method = "lm", se = FALSE,
color = "black", linetype = "longdash", linewidth = 1.3) +
# ---- Annotations highlighting the paradox ----
# Label the confounder: different x-distributions by group
annotate("segment", x = 5, xend = 5,
y = min(df$y) - 0.5, yend = max(df$y) + 0.5,
linetype = "dotted", color = "grey40") +
# Within-group positive relationship annotation (two arrows)
annotate("label", x = 2.2, y = 14.8,
label = "Within each group:\npositive relationship",
size = 4.2, fill = "#F8F8F8", color = "grey20", label.size = 0.2) +
annotate("curve", x = 2.2, y = 14.3, xend = 3.6, yend = 13.5,
curvature = 0.25, color = pal["Group A"],
arrow = arrow(length = unit(0.25, "cm"))) +
annotate("curve", x = 2.2, y = 15.2, xend = 8.3, yend = 4.0,
curvature = -0.2, color = pal["Group B"],
arrow = arrow(length = unit(0.25, "cm"))) +
# Aggregated negative relationship annotation
annotate("label", x = 7.8, y = 9.8,
label = "Aggregated (dashed) trend:\nnegative ⇒ Simpson's paradox",
size = 4.2, fill = "#FFF3F0", color = "grey20", label.size = 0.2) +
annotate("curve", x = 7.6, y = 9.4, xend = 6.6, yend = 7.2,
curvature = 0.3, color = "black",
arrow = arrow(length = unit(0.25, "cm"))) +
# ---- Scales, labels, theme ----
scale_color_manual(values = pal) +
labs(
x = "x",
y = "y",
color = "Group"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "inside",
legend.position.inside = c(.5,.9),
legend.title = element_blank(),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 16),
plot.subtitle = element_text(size = 12, color = "grey30"),
plot.caption = element_text(color = "grey40")
)
p
#| fig-cap: "OLS regression & Simpson's Paradox"
#| fig-subcap:
#|  - "OLS regression with cross-sectional data"
#|  - "Simpson's Paradox"
#| label: fig-simp
#| eval: true
#| echo: false
#| layout-ncol: 2
#| warning: false
mtcars |>
ggplot(aes(x = hp, y = mpg)) +
geom_point(size = 2, alpha = .5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
labs(x = "Horsepower", y = "Miles-per-gallon",
caption = "Data: mtcars")
set.seed(42)
# ---- Simulate data ----
# Within each group: y increases with x (positive slope).
# Groups differ in their x-range and intercepts (confounder).
n <- 250
df <- bind_rows(
tibble(group = "Group A",
x = runif(n, 0, 5),
y = 0.6 * x + 12 + rnorm(n, sd = 0.6)),
tibble(group = "Group B",
x = runif(n, 5, 10),
y = 0.6 * x - 2 + rnorm(n, sd = 0.6))
)
# ---- Fit simple linear models ----
overall_lm <- lm(y ~ x, data = df)
overall_slope <- unname(coef(overall_lm)[2])
group_lm <- df %>%
group_by(group) %>%
summarise(
slope = unname(coef(lm(y ~ x))[2]),
intercept = unname(coef(lm(y ~ x))[1]),
.groups = "drop"
)
# ---- Colors (Okabe–Ito, colorblind-friendly) ----
pal <- c("Group A" = "#0072B2",  # blue
"Group B" = "#D55E00")  # vermillion
# ---- Build plot ----
p <- ggplot(df, aes(x = x, y = y, color = group)) +
# Light background shading to reveal different x-ranges (confounder)
annotate("rect", xmin = 0, xmax = 5, ymin = -Inf, ymax = Inf,
fill = "grey90", alpha = 0.25) +
annotate("rect", xmin = 5, xmax = 10, ymin = -Inf, ymax = Inf,
fill = "grey95", alpha = 0.25) +
# Points and within-group regressions
geom_point(alpha = 0.55, size = 2) +
geom_smooth(method = "lm", se = FALSE, size = 1.2) +
# Aggregated regression (dashed black): shows reversal
geom_smooth(aes(group = 1), method = "lm", se = FALSE,
color = "black", linetype = "longdash", linewidth = 1.3) +
# ---- Annotations highlighting the paradox ----
# Label the confounder: different x-distributions by group
annotate("segment", x = 5, xend = 5,
y = min(df$y) - 0.5, yend = max(df$y) + 0.5,
linetype = "dotted", color = "grey40") +
# Within-group positive relationship annotation (two arrows)
annotate("label", x = 2.2, y = 14.8,
label = "Within each group:\npositive relationship",
size = 4.2, fill = "#F8F8F8", color = "grey20", label.size = 0.2) +
annotate("curve", x = 2.2, y = 14.3, xend = 3.6, yend = 13.5,
curvature = 0.25, color = pal["Group A"],
arrow = arrow(length = unit(0.25, "cm"))) +
annotate("curve", x = 2.2, y = 15.2, xend = 8.3, yend = 4.0,
curvature = -0.2, color = pal["Group B"],
arrow = arrow(length = unit(0.25, "cm"))) +
# Aggregated negative relationship annotation
annotate("label", x = 7.8, y = 9.8,
label = "Aggregated (dashed) trend:\nnegative ⇒ Simpson's paradox",
size = 4.2, fill = "#FFF3F0", color = "grey20", label.size = 0.2) +
annotate("curve", x = 7.6, y = 9.4, xend = 6.6, yend = 7.2,
curvature = 0.3, color = "black",
arrow = arrow(length = unit(0.25, "cm"))) +
# ---- Scales, labels, theme ----
scale_color_manual(values = pal) +
labs(
x = "x",
y = "y",
color = "Group"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "inside",
legend.position.inside = c(.8,.9),
legend.title = element_blank(),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", size = 16),
plot.subtitle = element_text(size = 12, color = "grey30"),
plot.caption = element_text(color = "grey40")
)
p
pandat <- tribble(
~u, ~t,~x,~gap,~c,
"A", 1, 1.4,0,2,
"A", 2, 1.7,0,2,
"A", 3, 2.1,0,2,
"B", 1, 2.1,5.24,1.5,
"B", 2, 2.5,5.24,1.5,
"B", 3, 2.7,5.24,1.5,
"C", 1, 1.9,2.4,3.5,
"C", 2, 2.0,2.4,3.5,
"C", 3, 2.3,2.4,3.5,
)
set.seed(13)
pandat |>
mutate(y = 2.7 - 1.59*x + gap + rnorm(9, mean = 0, sd = .25)) |>
mutate(across(c(x,y),
~ round(.x, digits = 1))) |>
select(-gap) -> pandat
pandat
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F)
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed")
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed")
scale_color_viridis_d()
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
scale_color_viridis_d()
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
scale_color_manual(values = c("#7fc97f","#beaed4","#fdc086"))
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
scale_color_manual(values = c("#7fc97f","#beaed4","#fdc086")) +
labs(color = "Group (u)") +
theme(legend.position = "bottom")
#| label: fig-pandat
#| fig-cap: "Relationship between x and y in simulated data"
#| echo: f
#| eval: t
pandat |>
ggplot(aes(x = x, y = y)) +
geom_point(aes(color = u)) +
geom_smooth(aes(group = u, color = u), method = "lm", se = F) +
geom_text(aes(label = t, group = u, color = u), vjust = 1.5) +
geom_smooth(method = "lm", se = F, color = "black", linetype = "dashed") +
scale_color_manual(values = c("#7fc97f","#beaed4","#fdc086")) +
labs(color = "Group (u)") +
theme(legend.position = "bottom")
pooled_plm <- plm::plm(y ~ x,
index = c("u","t"),
model = "pooling",
data = pandat)
summary(pooled_plm)
pooled_lm <- lm(y ~ x,
data = pandat)
summary(pooled_lm)
screenreg(list(pooled_plm,pooled_lm),
stars = 0.05,
custom.model.names = c("Regular OLS",
"Pooling (plm)"))
screenreg(list(pooled_plm,pooled_lm),
stars = 0.05,
custom.model.names = c("Pooling (plm)",
"Regular OLS"))
pandat |>
group_by(u) |>
summarise(avg_y = mean(y),
avg_x = mean(x)) -> pan_ag
pan_ag |>
ggplot(aes(x = avg_x, y = avg_y)) +
geom_text(aes(label = u)) +
geom_smooth(method = "lm", se = F)
be1 <- lm(avg_y ~ avg_x,
data = pan_ag)
summary(be1)
be_plm <- plm::plm(y ~ x,
index = c("u","t"),
model = "between",
data = pandat)
summary(be_plm)
screenreg(list(be_ols,be_plm),
stars = 0.05,
custom.model.names = c("OLS with aggregated data",
"Between-effects model (plm)"))
be_ols <- lm(avg_y ~ avg_x,
data = pan_ag)
summary(be_ols)
be_plm <- plm::plm(y ~ x,
index = c("u","t"),
model = "between",
data = pandat)
summary(be_plm)
screenreg(list(be_ols,be_plm),
stars = 0.05,
custom.model.names = c("OLS with aggregated data",
"Between-effects model (plm)"))
fe_ols <- lm(diff_y ~ diff_x,
data = pandat)
pandat |>
group_by(u) |>
mutate(avg_x = mean(x),
avg_y = mean(y)) |>
ungroup() |>
mutate(diff_x = x - avg_x,
diff_y = y - avg_y) -> pandat
fe_ols <- lm(diff_y ~ diff_x,
data = pandat)
summary(fe_ols)
fe_plm <- plm::plm(y ~ x,
index = c("u","t"),
model = "within",
data = pandat)
summary(fe_plm)
fe_dum <- lm(y ~ x + u,
data = pandat)
summary(fe_dum)
screenreg(list(fe_ols,fe_plm,fe_dum),
stars = 0.05,
custom.model.names = c("Regular OLS (dem. data)",
"Fixed-effects (plm)",
"Fixed-effects (dummies)"))
?plm()
pandat
pandat |>
group_by(u) |>
mutate(avg_c = mean(c)) |>
ungroup() |>
mutate(diff_c = c - avg_c) -> pandat
pandat |>
select(u,t,c,avg_c,diff_c)
fe_ols_c <- lm(y ~ c,
data = pandat)
summary(fe_ols_c)
fe_ols_c <- lm(y ~ c + u,
data = pandat)
summary(fe_ols_c)
fe_plm_c <- plm(y ~ c,
index = c("u","t"),
model = "within",
data = "pandat")
fe_plm_c <- plm(y ~ c,
index = c("u","t"),
model = "within",
data = pandat)
fe_ols_c <- lm(y ~ c + u,
data = pandat)
summary(fe_ols_c)
fe_plm_c <- plm(y ~ c,
index = c("u","t"),
model = "within",
data = pandat)
fe_plm_c <- plm(y ~ c,
index = c("u","t"),
model = "between",
data = pandat)
summary(fe_plm_c)
library(dagitty)
install.packages("dagitty")
library(dagitty)
# Define the DAG with an intermediary "Strength" variable
dag <- dagitty("dag {
A -> Strength -> B
C -> Strength
}")
# Plot the DAG
plot(dag)
library(dagitty)
# Define the DAG with an intermediary "Strength" variable
dag <- dagitty("dag {
A -> [] -> B
C -> []
}")
library(dagitty)
# Define the DAG with an intermediary "Strength" variable
dag <- dagitty("dag {
A -> "->" -> B
C -> []
}")
